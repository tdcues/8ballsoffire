<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Defense Attempts – Season 2025</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1.5rem;
      background: #111;
      color: #eee;
    }

    h1 {
      text-align: center;
      margin-bottom: 2rem;
    }

    .player-section {
      border: 1px solid #444;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      background: #181818;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .player-section h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.4rem;
    }

    .player-section h3 {
      margin: 0.75rem 0 0.25rem 0;
      font-size: 1.05rem;
    }

    table.stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    table.stats-table th,
    table.stats-table td {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid #333;
      text-align: center;
    }

    table.stats-table thead {
      background: #222;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    table.stats-table tbody tr:nth-child(even) {
      background: #1c1c1c;
    }

    table.stats-table tbody tr:nth-child(odd) {
      background: #151515;
    }

    .wl-W {
      color: #3ecf8e;
      font-weight: 600;
    }

    .wl-L {
      color: #ff6b6b;
      font-weight: 600;
    }

    .no-data {
      font-style: italic;
      color: #aaa;
      margin: 0.25rem 0;
    }

    #status {
      margin-bottom: 1rem;
      font-size: 0.95rem;
      color: #ddd;
    }

    a {
      color: #7fc4ff;
    }

    .error {
      color: #ff8080;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>Defense Attempts – 8-Ball &amp; 9-Ball (2025 Season)</h1>
  <div id="status">Loading data from <code>2025.html</code> and weekly pages…</div>
  <div id="results"></div>

  <script>
    // Adjust this if the file lives elsewhere relative to THIS html file
    const SEASON_URL = "2025.html";

    // Known players for the 2025 season
    const PLAYERS = [
      "Tom",
      "Rob",
      "Alexis",
      "Linzay",
      "Steve",
      "Peter",
      "David",
      "Mike"
    ];

    // Main entry
    document.addEventListener("DOMContentLoaded", () => {
      loadSeason().catch(err => {
        const status = document.getElementById("status");
        status.textContent = "Error loading season data.";
        status.classList.add("error");
        console.error(err);
      });
    });

    async function loadSeason() {
      const status = document.getElementById("status");
      status.textContent = "Fetching 2025.html…";

      const resp = await fetch(SEASON_URL);
      if (!resp.ok) {
        throw new Error("Failed to fetch " + SEASON_URL + ": " + resp.status);
      }
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      // Build (player, week, url) from the season page
      const playerLinks = extractPlayerLinksFromSeason(doc);

      if (playerLinks.length === 0) {
        status.textContent =
          "Found no per-week links for the specified players. Check selectors or HTML structure.";
        status.classList.add("error");
        return;
      }

      status.textContent = `Found ${playerLinks.length} match links. Fetching weekly pages…`;

      // Initialize results structure
      const results = {};
      for (const p of PLAYERS) {
        results[p] = { "8": [], "9": [] }; // "8" → 8-ball, "9" → 9-ball
      }

      // Process each weekly stats HTML
      for (let i = 0; i < playerLinks.length; i++) {
        const pl = playerLinks[i];
        status.textContent = `Processing ${i + 1}/${playerLinks.length}: ${pl.player}, Week ${pl.week}…`;

        try {
          const stats = await parseStatsPage(pl.url, pl.player);
          if (!stats) continue;

          const { gameType, attempts, wl, matchPoints } = stats;

          if (!results[pl.player][gameType]) {
            results[pl.player][gameType] = [];
          }

          results[pl.player][gameType].push({
            week: pl.week,
            attempts,
            wl,
            matchPoints
          });
        } catch (e) {
          console.warn("Failed to parse", pl.url, "for", pl.player, e);
        }
      }

      status.textContent = "Done. Rendering tables…";
      renderTables(results);
      status.textContent = "Completed.";
    }

    /**
     * Extracts per-player per-week stat page URLs from 2025.html.
     *
     * ASSUMPTIONS (you can tweak this if your HTML differs):
     *  - Each week has a heading like "Week 1", "Week 2", etc. in an H1–H6 tag.
     *  - Immediately following that heading there is a table with player rows.
     *  - The first cell in each row contains the player's name.
     *  - That row has one or more <a href="...html"> links to the 8-ball / 9-ball stat pages.
     */
    function extractPlayerLinksFromSeason(doc) {
      const playerSet = new Set(PLAYERS);
      const links = [];

      // Walk in document order to keep weeks in sequence
      const walker = doc.createTreeWalker(
        doc.body,
        NodeFilter.SHOW_ELEMENT,
        null,
        false
      );

      let currentWeek = null;

      while (walker.nextNode()) {
        const el = walker.currentNode;

        // Detect "Week X" headings
        if (/^H[1-6]$/.test(el.tagName)) {
          const m = el.textContent.match(/Week\s+(\d+)/i);
          if (m) {
            currentWeek = parseInt(m[1], 10);
          }
        }

        // For each row in a table following a week heading
        if (el.tagName === "TR" && currentWeek !== null) {
          const cells = el.querySelectorAll("td,th");
          if (!cells.length) continue;

          const rawName = cells[0].textContent.trim();
          if (!rawName) continue;

          // Only our team players
          if (!playerSet.has(rawName)) continue;

          const anchors = el.querySelectorAll('a[href$=".html"]');
          anchors.forEach(a => {
            const href = a.getAttribute("href");
            if (!href) return;
            const url = new URL(href, SEASON_URL).href;
            links.push({
              player: rawName,
              week: currentWeek,
              url
            });
          });
        }
      }

      return links;
    }

    /**
     * Parse a single weekly stats HTML page.
     *
     * Requirements from your description:
     *  - Determine game type using:
     *      "Eight on the breaks:" → 8-ball
     *      "Nine on the snaps:"  → 9-ball
     *    (you mentioned "line 42", but for robustness we search the whole file)
     *
     *  - Determine if the player is the Top or Bottom player by checking
     *    lines 39 and 51 for the player's name.
     *
     *  - From the matching player's category (Top or Bottom), pull:
     *      • Defense Attempt from line "Successful defenses: X of Y"
     *        → we display Y (attempts, i.e. the number after "of").
     *      • Match points from "Match points: N".
     *
     *  - Win/Loss logic:
     *      • 8-ball: W if match points is 2 or 3 (>=2).
     *      • 9-ball: W if 12 ≤ match points ≤ 20.
     */
    async function parseStatsPage(url, playerName) {
      const resp = await fetch(url);
      if (!resp.ok) {
        console.warn("Failed to fetch stats page:", url, resp.status);
        return null;
      }
      const text = await resp.text();
      const lines = text.split(/\r?\n/);

      const lower = text.toLowerCase();
      let gameType = null;

      if (lower.includes("eight on the breaks:")) {
        gameType = "8";
      } else if (lower.includes("nine on the snaps:")) {
        gameType = "9";
      } else {
        console.warn("Unknown game type for", url);
        return null;
      }

      // Determine Top vs Bottom based on given line numbers
      let category = null;
      const lineTop = lines[38] || "";
      const lineBottom = lines[50] || "";

      if (lineTop.includes(playerName)) {
        category = "top";
      } else if (lineBottom.includes(playerName)) {
        category = "bottom";
      } else {
        // Fallback: search for "Top Player"/"Bottom Player" with player name
        const idxTop = lines.findIndex(
          l => /top player/i.test(l) && l.includes(playerName)
        );
        const idxBottom = lines.findIndex(
          l => /bottom player/i.test(l) && l.includes(playerName)
        );
        if (idxTop !== -1) {
          category = "top";
        } else if (idxBottom !== -1) {
          category = "bottom";
        } else {
          console.warn("Could not determine Top/Bottom for", playerName, "in", url);
          return null;
        }
      }

      // Collect all lines with the key phrases
      const successLines = lines.filter(l =>
        /Successful defenses:/i.test(l)
      );
      const matchLines = lines.filter(l =>
        /Match points:/i.test(l)
      );

      let successLine, matchLine;

      if (category === "top") {
        successLine = successLines[0] || "";
        matchLine = matchLines[0] || "";
      } else {
        // bottom
        successLine = successLines[1] || successLines[0] || "";
        matchLine = matchLines[1] || matchLines[0] || "";
      }

      // Parse "Successful defenses: X of Y"
      const defMatch = successLine.match(
        /Successful defenses:\s*(\d+)\s*of\s*(\d+)/i
      );
      if (!defMatch) {
        console.warn("Failed to parse Successful defenses for", url, successLine);
        return null;
      }
      const attempts = parseInt(defMatch[2], 10); // number after "of"

      // Parse "Match points: N"
      const mpMatch = matchLine.match(/Match points:\s*(\d+)/i);
      if (!mpMatch) {
        console.warn("Failed to parse Match points for", url, matchLine);
        return null;
      }
      const matchPoints = parseInt(mpMatch[1], 10);

      // Determine W/L
      let wl = "";
      if (gameType === "8") {
        wl = matchPoints >= 2 ? "W" : "L";
      } else if (gameType === "9") {
        wl = matchPoints >= 12 && matchPoints <= 20 ? "W" : "L";
      }

      return { gameType, attempts, wl, matchPoints };
    }

    function renderTables(results) {
      const container = document.getElementById("results");
      container.innerHTML = "";

      const playersSorted = Object.keys(results).sort();

      for (const player of playersSorted) {
        const section = document.createElement("section");
        section.className = "player-section";

        const h2 = document.createElement("h2");
        h2.textContent = player;
        section.appendChild(h2);

        // 8-ball table
        renderGameTable(section, results[player]["8"], "8-Ball");

        // 9-ball table
        renderGameTable(section, results[player]["9"], "9-Ball");

        container.appendChild(section);
      }
    }

    function renderGameTable(parent, games, title) {
      const h3 = document.createElement("h3");
      h3.textContent = title;
      parent.appendChild(h3);

      if (!games || games.length === 0) {
        const p = document.createElement("p");
        p.className = "no-data";
        p.textContent = "No data available.";
        parent.appendChild(p);
        return;
      }

      games.sort((a, b) => a.week - b.week);

      const table = document.createElement("table");
      table.className = "stats-table";

      const thead = document.createElement("thead");
      thead.innerHTML =
        "<tr><th>Week No.</th><th>Defense Attempts</th><th>W/L</th><th>Match Points</th></tr>";
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      games.forEach(g => {
        const tr = document.createElement("tr");

        const wlClass = "wl-" + (g.wl || "").toUpperCase();

        tr.innerHTML =
          `<td>${g.week}</td>` +
          `<td>${g.attempts}</td>` +
          `<td class="${wlClass}">${g.wl}</td>` +
          `<td>${g.matchPoints}</td>`;

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      parent.appendChild(table);
    }
  </script>
</body>
</html>
